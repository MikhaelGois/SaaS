// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String?
  role      UserRole  @default(WAITER) // cashier, waiter, manager
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  orders    Order[]
}

enum UserRole {
  CASHIER
  WAITER
  MANAGER
  ADMIN
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id               String              @id @default(uuid())
  name             String              @unique
  description      String?
  price            Decimal             @db.Decimal(10, 2)
  categoryId       String
  category         Category            @relation(fields: [categoryId], references: [id])
  ingredients      ProductIngredient[]
  available        Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  orderItems       OrderItem[]
}

model Ingredient {
  id               String              @id @default(uuid())
  name             String              @unique
  stock            Decimal             @db.Decimal(10, 2)
  unit             String              // e.g., "g", "ml", "unit"
  minStockAlert    Decimal             @db.Decimal(10, 2) @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  productIngredients ProductIngredient[]
}

model ProductIngredient {
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  quantity     Decimal    @db.Decimal(10, 2)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@id([productId, ingredientId])
}

model Table {
  id        String    @id @default(uuid())
  number    Int       @unique
  capacity  Int
  status    TableStatus @default(AVAILABLE)
  orders    Order[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  CLEANING
}

model Order {
  id             String        @id @default(uuid())
  orderNumber    String        @unique @default(cuid()) // Unique identifier for the order
  userId         String?       // User who created the order (waiter/cashier)
  user           User?         @relation(fields: [userId], references: [id])
  tableId        String?       // For saloon orders
  table          Table?        @relation(fields: [tableId], references: [id])
  type           OrderType     // SALOON, COUNTER, DELIVERY
  status         OrderStatus   @default(PENDING)
  totalAmount    Decimal       @db.Decimal(10, 2)
  paymentId      String?       @unique // Optional: Link to a payment
  payment        Payment?
  customerName   String?
  customerPhone  String?
  deliveryAddress String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  items          OrderItem[]
}

enum OrderType {
  SALOON
  COUNTER
  DELIVERY
}

enum OrderStatus {
  PENDING      // Order created, not yet processed by kitchen
  PREPARING    // Kitchen is preparing
  READY        // Ready for pickup/delivery/serving
  SERVED       // Served to table
  COMPLETED    // Payment completed
  CANCELLED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal  @db.Decimal(10, 2) // Price at the time of order
  status    OrderItemStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}

model Payment {
  id            String      @id @default(uuid())
  orderId       String      @unique
  order         Order       @relation(fields: [orderId], references: [id])
  amount        Decimal     @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?     @unique // e.g., Stripe/Mercado Pago transaction ID
  paidAt        DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  CASH
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

